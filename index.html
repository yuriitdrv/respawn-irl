<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title id="app-title">Respawn IRL - Real Quest Map</title>
    <!-- Leaflet CSS & JS for Map -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha2d-p4xR2/rP+D38c1/r2f2o8g/2e7k2d/2/3f2o8g/2e7k2d/2/3f2o8g==" crossorigin="" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha2d-p4xR2/rP+D38c1/r2f2o8g/2e7k2d/2/3f2o8g/2e7k2d/2/3f2o8g==" crossorigin=""></script>
    <!-- Font Awesome for Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <!-- Tailwind CSS for utility styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            height: 100vh;
            overflow: hidden;
            background-color: #f3f4f6;
        }
        #map-container {
            flex-grow: 1;
            position: relative;
        }
        #map {
            width: 100%;
            height: 100%;
            border-radius: 12px;
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.2);
            overflow: hidden;
        }
        .controls {
            position: absolute;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 12px;
            background: linear-gradient(145deg, rgba(255, 255, 255, 0.95), rgba(240, 240, 240, 0.9));
            padding: 16px;
            border-radius: 16px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            z-index: 1000;
            transition: all 0.3s ease-in-out;
            backdrop-filter: blur(5px);
            width: 90%; /* Responsive control */
            max-width: 500px;
        }
        .top-bar {
            display: flex;
            justify-content: space-between;
            width: 100%;
            gap: 10px;
        }
        .main-buttons {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
            justify-content: center;
            width: 100%;
        }
        .filter-buttons-container {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 12px;
            max-height: 200px;
            opacity: 1;
            overflow: hidden;
            transition: max-height 0.4s ease-in-out, opacity 0.4s ease-in-out;
            width: 100%;
            padding-top: 5px;
            border-top: 1px solid #e5e7eb;
        }
        .filter-buttons-container.collapsed {
            max-height: 0;
            opacity: 0;
            padding: 0;
            margin: 0;
            border-top: none;
        }
        .control-button, .survival-button {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 10px 18px;
            border: none;
            border-radius: 10px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease-in-out;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            flex-grow: 1;
            min-width: 120px;
        }
        /* Styles for different button types */
        .control-button { background-color: #e2e8f0; color: #4b5563; }
        .control-button:hover { background-color: #cbd5e1; }
        .control-button.active { background-color: #3b82f6; color: white; box-shadow: 0 4px 8px rgba(59, 130, 246, 0.3); }
        .control-button.active:hover { background-color: #2563eb; }
        .survival-button { background-color: #ef4444; color: white; animation: pulse 2s infinite; }
        .survival-button:hover { background-color: #dc2626; }
        .control-button i, .survival-button i { margin-right: 6px; }

        /* Status Message */
        .status-message {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.75);
            color: white;
            padding: 10px 20px;
            border-radius: 8px;
            font-size: 14px;
            z-index: 1001;
            display: none;
            opacity: 0;
            transition: opacity 0.5s ease-in-out;
            max-width: 90%;
            text-align: center;
        }
        
        /* Custom Marker Styles */
        .icon-toilet, .icon-food, .icon-charger, .icon-center {
            background-color: white;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            border: 2px solid;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        .icon-toilet { border-color: #3b82f6; }
        .icon-food { border-color: #10b981; }
        .icon-charger { border-color: #f59e0b; }
        .icon-center { border-color: #8b5cf6; }
        .icon-toilet i { color: #3b82f6; }
        .icon-food i { color: #10b981; }
        .icon-charger i { color: #f59e0b; }
        .icon-center i { color: #8b5cf6; }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
    </style>
</head>
<body>
    <div id="map-container">
        <div id="map"></div>
        <div class="controls">
            <div class="top-bar">
                <button id="locate-me-btn" class="control-button">
                    <i class="fa-solid fa-crosshairs"></i> Locate Me
                </button>
                <button id="survival-mode-btn" class="survival-button">
                    <i class="fa-solid fa-compass"></i> Survival Mode
                </button>
                <button id="menu-toggle-btn" class="control-button" style="min-width: 50px;">
                    <i class="fa-solid fa-bars"></i>
                </button>
                <!-- Removed Language Toggle Button -->
            </div>
            <div id="filter-buttons-container" class="filter-buttons-container collapsed">
                <button class="control-button active" data-filter="all" data-i18n="all">
                    <i class="fa-solid fa-list-ul"></i> All
                </button>
                <button class="control-button" data-filter="toilet" data-i18n="toilets">
                    <i class="fa-solid fa-toilet"></i> Toilets
                </button>
                <button class="control-button" data-filter="food" data-i18n="food">
                    <i class="fa-solid fa-utensils"></i> Food
                </button>
                <button class="control-button" data-filter="charger" data-i18n="chargers">
                    <i class="fa-solid fa-charging-station"></i> Charging
                </button>
                <button class="control-button" data-filter="center" data-i18n="centers">
                    <i class="fa-solid fa-handshake-angle"></i> Help Centers
                </button>
            </div>
        </div>
        <div id="status-message" class="status-message"></div>
    </div>

    <script>
        (function() {
            // =========================================================================================
            // GLOBAL LOCALIZATION (i18n) - Locked to English
            // =========================================================================================
            const currentLang = 'en'; 

            const translations = {
                en: {
                    title: 'Respawn IRL - Real Quest Map',
                    locate_me: 'Locate Me',
                    survival_mode: 'Survival Mode',
                    menu: 'Menu',
                    all: 'All',
                    toilets: 'Toilets',
                    food: 'Food',
                    chargers: 'Charging',
                    centers: 'Help Centers',
                    you_are_here: 'You are here.',
                    plot_route: 'Get Directions',
                    your_selected_point: 'Your selected point.',
                    location_found: 'Your location has been found.',
                    new_destination: (distance) => `New destination set. Distance: ${distance} km.`,
                    nearest_point: (name, distance) => `Nearest help point: ${name}, ${distance} km.`,
                    need_location: 'Please determine your location first.',
                    no_points: 'There are no available help centers or food points on the map.',
                    no_geolocation: 'Geolocation is not supported by your browser.',
                    error_1: 'Geolocation access denied by user. Please allow access in your browser settings.',
                    error_2: 'Location information unavailable (check GPS/Wi-Fi).',
                    error_3: 'Geolocation request timed out. Please try again.',
                    error_default: (code) => `Geolocation Error (Code: ${code}).`,
                    location_error_general: 'Could not determine your location.'
                }
            };

            // Simplified T function, always defaults to English
            function T(key, ...args) {
                const lang = translations[currentLang];
                const text = lang[key] || key; // Fallback to key itself if translation is missing
                if (typeof text === 'function') {
                    return text(...args);
                }
                return text; 
            }

            function updateUI() {
                // Update page title
                document.getElementById('app-title').textContent = T('title');
                
                // Static buttons are now hardcoded in HTML, so only dynamic elements remain
                
                // Update filter buttons (re-applies text based on T function if needed)
                document.querySelectorAll('[data-i18n]').forEach(el => {
                    const key = el.getAttribute('data-i18n');
                    const textNode = el.querySelector('i') ? el.querySelector('i').nextSibling : el.firstChild;
                    if (textNode) {
                        textNode.textContent = ` ${T(key)}`;
                    } else {
                         el.textContent = T(key);
                    }
                });

                // Reload markers to refresh popups with English content
                const activeFilterBtn = document.querySelector('.control-button.active[data-filter]');
                const activeFilter = activeFilterBtn ? activeFilterBtn.dataset.filter : 'all';
                addMarkers(activeFilter);
            }


            // --- MARKER CONFIGURATION ---
            const icons = {
                toilet: L.divIcon({ className: 'icon-toilet', html: '<i class="fa-solid fa-toilet"></i>', iconSize: [30, 30] }),
                food: L.divIcon({ className: 'icon-food', html: '<i class="fa-solid fa-utensils"></i>', iconSize: [30, 30] }),
                charger: L.divIcon({ className: 'icon-charger', html: '<i class="fa-solid fa-charging-station"></i>', iconSize: [30, 30] }),
                center: L.divIcon({ className: 'icon-center', html: '<i class="fa-solid fa-handshake-angle"></i>', iconSize: [30, 30] }),
            };

            // =========================================================================================
            // DUBLIN HELP ADDRESSES (Using English descriptions)
            // =========================================================================================
            const pointsData = [
                { 
                    lat: 53.3395, lng: -6.2550, 
                    type: 'food', 
                    name_en: 'St. Brigid\'s Food Centre', 
                    description_en: 'Address: Holles Row, D2. Hours: Mon-Sat, 11:30–13:15. Free.'
                },
                { 
                    lat: 53.3446, lng: -6.2642, 
                    type: 'food', 
                    name_en: 'Focus Ireland Coffee Shop', 
                    description_en: 'Address: 15 Eustace Street, D2. Hours: Mon, Tue, Thu, Fri, 10:00–15:30. Small lunch €0.80.'
                },
                { 
                    lat: 53.3601, lng: -6.2910, 
                    type: 'food', 
                    name_en: 'St. Joseph\'s Penny Dinners', 
                    description_en: 'Address: 67 Aughrim House, D7. Hours: Mon-Sat, 12:00–13:00 (lunch). Cost: €0.60/€0.40.'
                },
                { 
                    lat: 53.3551, lng: -6.2520, 
                    type: 'food', 
                    name_en: 'St. Agatha\'s Food Centre', 
                    description_en: 'Address: 33 Portland Row, D1. Hours: Mon-Fri, 12:00–13:00. Cost: €0.80.'
                },
                { 
                    lat: 53.3486, lng: -6.2750, 
                    type: 'center', 
                    name_en: 'Capuchin Day Centre (Main Center)', 
                    description_en: 'Address: Bow St, D7. Times: 9:00-11:30 (tea/coffee), 11:30-13:30 (lunch), 9:00-13:30 (Sun). **Free.**'
                },
                { 
                    lat: 53.3440, lng: -6.2730, 
                    type: 'center', 
                    name_en: 'Merchants Quay Ireland (MQI)', 
                    description_en: 'Address: 22a/b Merchants Quay, D8. Hours: Mon-Fri, 9:00–13:00 (breakfast/drop-in). Provides food, advice, toilet. Free.'
                },
                { 
                    lat: 53.3430, lng: -6.2735, 
                    type: 'food', 
                    name_en: 'Open Access Service', 
                    description_en: 'Address: Johns Lane West, D8. Hours: Mon-Fri, 17:00–20:00. Free.'
                },
                { 
                    lat: 53.3450, lng: -6.2740, 
                    type: 'food', 
                    name_en: 'Trocadero Theatre / Riverbank', 
                    description_en: 'Address: Riverbank, D8. Times: 7:30–9:00 (breakfast), 10:00–14:00 (lunch), 16:00–18:00 (dinner). Free.'
                }
            ];
            // =========================================================================================

            // Map Initialization (Dublin center)
            const map = L.map('map').setView([53.3498, -6.2603], 15);
            
            // Add OpenStreetMap layer
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                maxZoom: 19,
                attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'
            }).addTo(map);

            let userMarker = null;
            let markersLayer = new L.LayerGroup().addTo(map);
            let routeLine = null; 
            let destinationMarker = null; 

            // Helper function to display temporary status message
            function showStatusMessage(text) {
                const messageEl = document.getElementById('status-message');
                messageEl.textContent = text;
                messageEl.style.display = 'block';
                messageEl.style.opacity = '1';
                setTimeout(() => {
                    messageEl.style.opacity = '0';
                    setTimeout(() => messageEl.style.display = 'none', 500);
                }, 3000);
            }

            // Function to determine user location
            function getUserLocation() {
                if ('geolocation' in navigator) {
                    navigator.geolocation.getCurrentPosition(
                        position => {
                            const userLatLng = [position.coords.latitude, position.coords.longitude];

                            if (userMarker) {
                                userMarker.setLatLng(userLatLng);
                            } else {
                                userMarker = L.circleMarker(userLatLng, {
                                    radius: 8, fillColor: "#3b82f6", color: "#fff", weight: 2, opacity: 1, fillOpacity: 0.8
                                }).bindPopup(T('you_are_here'));
                                userMarker.addTo(map);
                            }

                            map.setView(userLatLng, 15);
                            showStatusMessage(T('location_found'));

                            if (destinationMarker) {
                                plotRouteToPoint(destinationMarker.getLatLng());
                            }
                        },
                        error => {
                            let errorMessage = T('location_error_general');
                            
                            if (error && error.code) {
                                switch (error.code) {
                                    case 1:
                                        errorMessage = T('error_1');
                                        break;
                                    case 2:
                                        errorMessage = T('error_2');
                                        break;
                                    case 3:
                                        errorMessage = T('error_3');
                                        break;
                                    default:
                                        errorMessage = T('error_default', error.code);
                                }
                            }

                            // Improved error logging for debugging
                            console.error(
                                'Geolocation Error (Code/Message):', 
                                error.code, 
                                error.message, 
                                '| Full Error Object:', error
                            );
                            showStatusMessage(errorMessage);
                        },
                        { enableHighAccuracy: true, timeout: 5000, maximumAge: 0 }
                    );
                } else {
                    showStatusMessage(T('no_geolocation'));
                }
            }
            
            // Distance calculation (Haversine Formula)
            function getDistance(lat1, lon1, lat2, lon2) {
                const R = 6371e3; // meters
                const φ1 = lat1 * Math.PI/180;
                const φ2 = lat2 * Math.PI/180;
                const Δφ = (lat2-lat1) * Math.PI/180;
                const Δλ = (lon2-lon1) * Math.PI/180;
            
                const a = Math.sin(Δφ/2) * Math.sin(Δφ/2) +
                          Math.cos(φ1) * Math.cos(φ2) *
                          Math.sin(Δλ/2) * Math.sin(Δλ/2);
                const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            
                return R * c;
            }

            // Function to plot route (simple line)
            function plotRouteToPoint(destLatLng) {
                if (!userMarker) {
                    showStatusMessage(T('need_location'));
                    return;
                }
                
                // Clear previous route and destination marker
                if (routeLine) {
                    map.removeLayer(routeLine);
                }
                if (destinationMarker) {
                    map.removeLayer(destinationMarker);
                }

                const userLatLng = userMarker.getLatLng();

                // Create destination marker 
                destinationMarker = L.marker(destLatLng, { icon: icons.center })
                    .bindPopup(T('your_selected_point'))
                    .addTo(map);

                // Create route line
                const latlngs = [userLatLng, destLatLng];
                routeLine = L.polyline(latlngs, {
                    color: '#8b5cf6',
                    weight: 5,
                    opacity: 0.7,
                    dashArray: '10, 10' 
                }).addTo(map);

                // Set map bounds to show both points
                const bounds = L.latLngBounds(userLatLng, destLatLng);
                map.fitBounds(bounds, { padding: [50, 50] });

                const distanceKm = (getDistance(userLatLng.lat, userLatLng.lng, destLatLng.lat, destLatLng.lng) / 1000).toFixed(2);
                showStatusMessage(T('new_destination', distanceKm));
            }

            // "Survival Mode" function - finds the nearest help center
            function findNearestHelpCenter() {
                if (!userMarker) {
                    showStatusMessage(T('need_location'));
                    return;
                }
                
                let centers = pointsData.filter(p => p.type === 'center' || p.type === 'food');

                if (centers.length === 0) {
                    showStatusMessage(T('no_points'));
                    return;
                }

                let nearestPoint = null;
                let minDistance = Infinity;
                const userLatLng = userMarker.getLatLng();

                centers.forEach(point => {
                    const distance = getDistance(userLatLng.lat, userLatLng.lng, point.lat, point.lng);
                    if (distance < minDistance) {
                        minDistance = distance;
                        nearestPoint = point;
                    }
                });

                if (nearestPoint) {
                    plotRouteToPoint({ lat: nearestPoint.lat, lng: nearestPoint.lng });
                    const distanceKm = (minDistance / 1000).toFixed(2);
                    const name = nearestPoint[`name_${currentLang}`];
                    showStatusMessage(T('nearest_point', name, distanceKm));
                }
            }

            // Function to add/filter markers on the map
            function addMarkers(filter = 'all') {
                markersLayer.clearLayers();
                pointsData.forEach(point => {
                    if (filter === 'all' || point.type === filter) {
                        const marker = L.marker([point.lat, point.lng], { icon: icons[point.type] });
                        
                        // Get English name and description
                        const name = point[`name_${currentLang}`];
                        const description = point[`description_${currentLang}`];

                        const popupContent = document.createElement('div');
                        
                        popupContent.innerHTML = `
                            <h4 style="font-weight: 700;">${name}</h4>
                            <p style="margin-bottom: 8px;">${description}</p>
                        `;

                        const routeButton = document.createElement('button');
                        routeButton.textContent = T('plot_route');
                        routeButton.style.cssText = 'background-color: #3b82f6; color: white; padding: 6px 12px; border: none; border-radius: 6px; cursor: pointer; margin-top: 5px; font-size: 13px;';
                        routeButton.onclick = () => {
                            window.plotRouteToPoint({lat: point.lat, lng: point.lng});
                            map.closePopup(); 
                        };
                        popupContent.appendChild(routeButton);
                        
                        marker.bindPopup(popupContent);
                        markersLayer.addLayer(marker);
                    }
                });
            }

            // Attach function to window so it can be called from the popup
            window.plotRouteToPoint = plotRouteToPoint;

            // --- EVENT HANDLERS ---

            // Handlers for filter buttons
            const filterButtons = document.querySelectorAll('.control-button[data-filter]');
            filterButtons.forEach(button => {
                button.addEventListener('click', () => {
                    filterButtons.forEach(btn => btn.classList.remove('active'));
                    button.classList.add('active');
                    const filter = button.dataset.filter;
                    addMarkers(filter);
                });
            });

            // Handler for "Survival Mode"
            document.getElementById('survival-mode-btn').addEventListener('click', findNearestHelpCenter);
            
            // Handler for "Locate Me"
            document.getElementById('locate-me-btn').addEventListener('click', getUserLocation);

            // Handler for collapsing/expanding the menu (mobile adaptation)
            document.getElementById('menu-toggle-btn').addEventListener('click', () => {
                const container = document.getElementById('filter-buttons-container');
                container.classList.toggle('collapsed');
            });

            // Handler for map click (to plot route to an arbitrary point)
            map.on('click', function(e) {
                plotRouteToPoint(e.latlng);
            });

            // Initial load
            updateUI(); 
            getUserLocation();
        })();
    </script>
</body>
</html>
