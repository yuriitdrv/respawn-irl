<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Respawn IRL - Реальная карта-квест</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha2d-p4xR2/rP+D38c1/r2f2o8g/2e7k2d/2/3f2o8g/2e7k2d/2/3f2o8g==" crossorigin="" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha2d-p4xR2/rP+D38c1/r2f2o8g/2e7k2d/2/3f2o8g/2e7k2d/2/3f2o8g==" crossorigin=""></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            height: 100vh;
            overflow: hidden;
            background-color: #f3f4f6;
        }
        #map-container {
            flex-grow: 1;
            position: relative;
        }
        #map {
            width: 100%;
            height: 100%;
            border-radius: 12px;
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.2);
            overflow: hidden;
        }
        .controls {
            position: absolute;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 12px;
            background: linear-gradient(145deg, rgba(255, 255, 255, 0.95), rgba(240, 240, 240, 0.9));
            padding: 16px;
            border-radius: 16px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            z-index: 1000;
            transition: all 0.3s ease-in-out;
            backdrop-filter: blur(5px);
        }
        .main-buttons {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
            justify-content: center;
        }
        .filter-buttons-container {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 12px;
            max-height: 200px;
            opacity: 1;
            overflow: hidden;
            transition: max-height 0.4s ease-in-out, opacity 0.4s ease-in-out;
        }
        .filter-buttons-container.collapsed {
            max-height: 0;
            opacity: 0;
            padding: 0;
            margin: 0;
        }
        .control-button, .survival-button {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 10px 18px;
            border: none;
            border-radius: 10px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease-in-out;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .control-button {
            background-color: #e2e8f0;
            color: #4b5563;
        }
        .control-button:hover {
            background-color: #cbd5e1;
        }
        .control-button.active {
            background-color: #3b82f6;
            color: white;
            box-shadow: 0 4px 8px rgba(59, 130, 246, 0.3);
        }
        .control-button.active:hover {
            background-color: #2563eb;
        }
        .survival-button {
            background-color: #ef4444;
            color: white;
            animation: pulse 2s infinite;
        }
        .survival-button:hover {
            background-color: #dc2626;
        }
        .control-button i, .survival-button i {
            margin-right: 6px;
        }
        .status-message {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.75);
            color: white;
            padding: 10px 20px;
            border-radius: 8px;
            font-size: 14px;
            z-index: 1001;
            display: none;
            opacity: 0;
            transition: opacity 0.5s ease-in-out;
            max-width: 80%;
            text-align: center;
        }
        .leaflet-popup-content-wrapper {
            border-radius: 8px !important;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }
        .leaflet-popup-content {
            font-size: 14px;
            line-height: 1.5;
        }
        .leaflet-popup-content h4 {
            font-weight: 700;
            margin-top: 0;
            margin-bottom: 8px;
        }
        .leaflet-popup-content p {
            margin: 0;
        }
        .leaflet-popup-content button {
            background-color:#3b82f6; 
            color:white; 
            padding:8px 12px; 
            border:none; 
            border-radius:6px; 
            margin-top:10px; 
            cursor:pointer;
            transition: background-color 0.2s;
        }
        .leaflet-popup-content button:hover {
            background-color:#2563eb;
        }
        .icon-toilet, .icon-food, .icon-charger, .icon-safe, .icon-unsafe, .icon-center, .icon-arrow {
            background-color: white;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            border: 2px solid;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        .icon-toilet { border-color: #3b82f6; }
        .icon-food { border-color: #10b981; }
        .icon-charger { border-color: #f59e0b; }
        .icon-safe { border-color: #10b981; }
        .icon-unsafe { border-color: #ef4444; }
        .icon-center { border-color: #8b5cf6; }
        .icon-arrow { 
            border-color: #8b5cf6; 
            background-color: #8b5cf6;
            transform-origin: center center;
            transition: transform 0.1s linear;
        }
        .icon-toilet i { color: #3b82f6; }
        .icon-food i { color: #10b981; }
        .icon-charger i { color: #f59e0b; }
        .icon-safe i { color: #10b981; }
        .icon-unsafe i { color: #ef4444; }
        .icon-center i { color: #8b5cf6; }
        .icon-arrow i { color: white; }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
    </style>
</head>
<body>
    <div id="map-container">
        <div id="map"></div>
        <div class="controls">
            <div class="main-buttons">
                <button id="locate-me-btn" class="control-button">
                    <i class="fa-solid fa-crosshairs"></i> Найти меня
                </button>
                <button id="survival-mode-btn" class="survival-button">
                    <i class="fa-solid fa-compass"></i> Режим выживания
                </button>
                <button id="menu-toggle-btn" class="control-button">
                    <i class="fa-solid fa-bars"></i> Меню
                </button>
            </div>
            <div id="filter-buttons-container" class="filter-buttons-container">
                <button class="control-button active" data-filter="all">
                    <i class="fa-solid fa-list-ul"></i> Все
                </button>
                <button class="control-button" data-filter="toilet">
                    <i class="fa-solid fa-toilet"></i> Туалеты
                </button>
                <button class="control-button" data-filter="food">
                    <i class="fa-solid fa-utensils"></i> Еда
                </button>
                <button class="control-button" data-filter="charger">
                    <i class="fa-solid fa-charging-station"></i> Зарядка
                </button>
                <button class="control-button" data-filter="center">
                    <i class="fa-solid fa-handshake-angle"></i> Центры помощи
                </button>
            </div>
        </div>
        <div id="status-message" class="status-message"></div>
    </div>

    <script>
        // Use a self-contained anonymous function to prevent global variable pollution
        (function() {
            // Define custom icons for different types of points of interest
            const icons = {
                toilet: L.divIcon({ className: 'icon-toilet', html: '<i class="fa-solid fa-toilet"></i>', iconSize: [30, 30] }),
                food: L.divIcon({ className: 'icon-food', html: '<i class="fa-solid fa-utensils"></i>', iconSize: [30, 30] }),
                charger: L.divIcon({ className: 'icon-charger', html: '<i class="fa-solid fa-charging-station"></i>', iconSize: [30, 30] }),
                center: L.divIcon({ className: 'icon-center', html: '<i class="fa-solid fa-handshake-angle"></i>', iconSize: [30, 30] }),
                arrow: L.divIcon({ className: 'icon-arrow', html: '<i class="fa-solid fa-location-arrow"></i>', iconSize: [30, 30] }),
            };

            // Hardcoded data for demonstration. In a real app, this would come from a backend.
            const pointsData = [
                { lat: 53.3486, lng: -6.2625, type: 'toilet', name: 'Общественный туалет', description: 'Рядом с центральным вокзалом.' },
                { lat: 53.3498, lng: -6.2650, type: 'food', name: 'Кафе-столовая "The Hungry Hub"', description: 'Бюджетная еда, есть горячие блюда.' },
                { lat: 53.3512, lng: -6.2588, type: 'charger', name: 'Центральная библиотека Дублина', description: 'Розетки в читальном зале, бесплатный Wi-Fi.' },
                { lat: 53.3450, lng: -6.2610, type: 'center', name: 'Центр помощи "Дублинская гавань"', description: 'Предоставляет ночлег и консультации.' },
                { lat: 53.3440, lng: -6.2570, type: 'food', name: 'Фуд-корт "George\'s Street Arcade"', description: 'Много вариантов, есть бесплатные туалеты.' },
                { lat: 53.3490, lng: -6.2690, type: 'toilet', name: 'Туалет в парке "St. Stephen\'s Green"', description: 'Чисто, работает до 22:00.' },
                { lat: 53.3500, lng: -6.2630, type: 'charger', name: 'Кофейня "Café Compass"', description: 'Можно зарядиться при покупке напитка.' },
                { lat: 53.3460, lng: -6.2550, type: 'center', name: 'Дублинский центр беженцев', description: 'Консультации, юридическая помощь.' }
            ];

            // Initialize the map with a default view. Dublin, City Centre is a good starting point.
            const map = L.map('map').setView([53.3498, -6.2603], 15);
            
            // Add OpenStreetMap tile layer
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                maxZoom: 19,
                attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'
            }).addTo(map);

            let userMarker = null;
            let markersLayer = new L.LayerGroup().addTo(map);
            let directionalArrow = null; 
            let destinationMarker = null; 

            // Function to display a temporary status message
            function showStatusMessage(text) {
                const messageEl = document.getElementById('status-message');
                messageEl.textContent = text;
                messageEl.style.display = 'block';
                messageEl.style.opacity = '1';
                setTimeout(() => {
                    messageEl.style.opacity = '0';
                    setTimeout(() => messageEl.style.display = 'none', 500);
                }, 3000);
            }

            // Function to handle geolocation
            function getUserLocation() {
                if ('geolocation' in navigator) {
                    navigator.geolocation.getCurrentPosition(
                        position => {
                            const lat = position.coords.latitude;
                            const lng = position.coords.longitude;
                            const userLatLng = [lat, lng];

                            // Add a marker for the user's location
                            if (userMarker) {
                                userMarker.setLatLng(userLatLng);
                            } else {
                                userMarker = L.circleMarker(userLatLng, {
                                    radius: 8,
                                    fillColor: "#3b82f6",
                                    color: "#fff",
                                    weight: 2,
                                    opacity: 1,
                                    fillOpacity: 0.8
                                }).bindPopup('Вы здесь.');
                                userMarker.addTo(map);
                            }

                            map.setView(userLatLng, 15);
                            showStatusMessage('Ваше местоположение найдено.');

                            // Check if a destination is set and update the arrow
                            if (destinationMarker) {
                                plotRouteToPoint(destinationMarker.getLatLng());
                            }
                        },
                        error => {
                            console.error('Ошибка геолокации:', error);
                            showStatusMessage('Не удалось определить ваше местоположение.');
                        },
                        { enableHighAccuracy: true, timeout: 5000, maximumAge: 0 }
                    );
                } else {
                    showStatusMessage('Геолокация не поддерживается вашим браузером.');
                }
            }
            
            // Function to calculate distance between two points (Haversine formula)
            function getDistance(lat1, lon1, lat2, lon2) {
                const R = 6371e3; // metres
                const φ1 = lat1 * Math.PI/180;
                const φ2 = lat2 * Math.PI/180;
                const Δφ = (lat2-lat1) * Math.PI/180;
                const Δλ = (lon2-lon1) * Math.PI/180;
            
                const a = Math.sin(Δφ/2) * Math.sin(Δφ/2) +
                          Math.cos(φ1) * Math.cos(φ2) *
                          Math.sin(Δλ/2) * Math.sin(Δλ/2);
                const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            
                return R * c; // in metres
            }

            // Function to calculate bearing between two points for the arrow
            function getBearing(startLat, startLng, endLat, endLng) {
                const toRad = (deg) => deg * Math.PI / 180;
                const toDeg = (rad) => rad * 180 / Math.PI;

                startLat = toRad(startLat);
                startLng = toRad(startLng);
                endLat = toRad(endLat);
                endLng = toRad(endLng);

                const y = Math.sin(endLng - startLng) * Math.cos(endLat);
                const x = Math.cos(startLat) * Math.sin(endLat) - Math.sin(startLat) * Math.cos(endLat) * Math.cos(endLng - startLng);
                const bearing = toDeg(Math.atan2(y, x));
                
                return (bearing + 360) % 360;
            }

            // Function to plot a route from the user's location to a specific destination
            function plotRouteToPoint(destLatLng) {
                if (!userMarker) {
                    showStatusMessage('Сначала определите свое местоположение.');
                    return;
                }
                
                // Clear the previous arrow and destination marker
                if (directionalArrow) {
                    map.removeLayer(directionalArrow);
                }
                if (destinationMarker) {
                    map.removeLayer(destinationMarker);
                }

                const userLatLng = userMarker.getLatLng();

                // Create the destination marker
                destinationMarker = L.marker(destLatLng, { icon: icons.center })
                    .bindPopup('Точка назначения.')
                    .addTo(map);

                // Create the directional arrow marker at the user's location
                directionalArrow = L.marker(userLatLng, { icon: icons.arrow }).addTo(map);

                // Calculate bearing for the arrow and apply rotation
                const bearing = getBearing(userLatLng.lat, userLatLng.lng, destLatLng.lat, destLatLng.lng);
                directionalArrow.getElement().style.transform = `rotate(${bearing}deg)`;

                // Fit map bounds to show both user and destination
                const bounds = L.latLngBounds(userLatLng, destLatLng);
                map.fitBounds(bounds, { padding: [50, 50] });

                const distanceKm = (getDistance(userLatLng.lat, userLatLng.lng, destLatLng.lat, destLatLng.lng) / 1000).toFixed(2);
                showStatusMessage(`Новая точка назначения установлена. Расстояние: ${distanceKm} км.`);
            }

            // Function to find the nearest help center and draw a path (original "Survival Mode")
            function findNearestHelpCenter() {
                if (!userMarker) {
                    showStatusMessage('Сначала определите свое местоположение.');
                    return;
                }
                
                // Filter for help centers
                const centers = pointsData.filter(p => p.type === 'center');
                if (centers.length === 0) {
                    showStatusMessage('На карте нет центров помощи.');
                    return;
                }

                let nearestCenter = null;
                let minDistance = Infinity;
                const userLatLng = userMarker.getLatLng();

                centers.forEach(center => {
                    const distance = getDistance(userLatLng.lat, userLatLng.lng, center.lat, center.lng);
                    if (distance < minDistance) {
                        minDistance = distance;
                        nearestCenter = center;
                    }
                });

                if (nearestCenter) {
                    plotRouteToPoint({ lat: nearestCenter.lat, lng: nearestCenter.lng });
                    const distanceKm = (minDistance / 1000).toFixed(2);
                    showStatusMessage(`Ближайший центр помощи: ${nearestCenter.name}, ${distanceKm} км.`);
                }
            }


            // Function to add all points to the map with new routing functionality
            function addMarkers(filter = 'all') {
                markersLayer.clearLayers();
                pointsData.forEach(point => {
                    if (filter === 'all' || point.type === filter) {
                        const marker = L.marker([point.lat, point.lng], { icon: icons[point.type] });
                        
                        // Create popup content with a new "Plot Route" button
                        const popupContent = document.createElement('div');
                        popupContent.innerHTML = `
                            <h4>${point.name}</h4>
                            <p>${point.description}</p>
                            <button onclick="window.plotRouteToPoint({lat: ${point.lat}, lng: ${point.lng}})"
                                style="background-color:#3b82f6; color:white; padding:8px 12px; border:none; border-radius:6px; margin-top:10px; cursor:pointer;">
                                Проложить маршрут
                            </button>
                        `;
                        marker.bindPopup(popupContent);
                        markersLayer.addLayer(marker);
                    }
                });
            }

            // Attach the plotRouteToPoint function to the window object so it can be called from the popup
            window.plotRouteToPoint = plotRouteToPoint;

            // Event listeners for filter buttons
            const filterButtons = document.querySelectorAll('.control-button[data-filter]');
            filterButtons.forEach(button => {
                button.addEventListener('click', () => {
                    filterButtons.forEach(btn => btn.classList.remove('active'));
                    button.classList.add('active');
                    const filter = button.dataset.filter;
                    addMarkers(filter);
                });
            });

            // Event listener for survival mode button
            document.getElementById('survival-mode-btn').addEventListener('click', findNearestHelpCenter);
            
            // Event listener for "Locate Me" button
            document.getElementById('locate-me-btn').addEventListener('click', getUserLocation);

            // Event listener for menu toggle button
            document.getElementById('menu-toggle-btn').addEventListener('click', () => {
                const container = document.getElementById('filter-buttons-container');
                container.classList.toggle('collapsed');
            });

            // Event listener for map clicks to set a new destination
            map.on('click', function(e) {
                plotRouteToPoint(e.latlng);
            });

            // Initial setup
            addMarkers('all');
            getUserLocation();
        })();
    </script>
</body>
</html>
